# ç”¨æˆ· Key ç®¡ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸ªäºº API Key ç®¡ç†ç³»ç»Ÿï¼Œä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ä¸“å±çš„ API Keyï¼Œå®ç°ï¼š
- âœ… æŒ‰ç”¨æˆ·ç»Ÿè®¡ä½¿ç”¨é‡ï¼ˆè¯·æ±‚æ•°ã€Token æ•°ï¼‰
- âœ… ä¸€ä¸ªç”¨æˆ·å¯ç”³è¯·å¤šä¸ª Keyï¼ˆä¸åŒè®¾å¤‡/é¡¹ç›®ï¼‰
- âœ… å†…å­˜ç¼“å­˜ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
- âœ… å®æ—¶ç»Ÿè®¡ï¼Œè‡ªåŠ¨èšåˆ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ Key æ± 

é¦–æ¬¡éƒ¨ç½²éœ€è¦é¢„ç”Ÿæˆä¸€æ‰¹ Keyï¼š

```bash
cd key-portal

# ç”Ÿæˆ 500 ä¸ª Key å¹¶è‡ªåŠ¨æ·»åŠ åˆ° CLIProxyAPI
python generate_keys.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
============================================================
ğŸ”‘ API Key Pool Generator
============================================================

ğŸ“ Generating 500 API keys...
âœ… Generated 500 keys

ğŸ’¾ Saving to key-portal/data/key_pool.json...
âœ… Saved 500 keys to key-portal/data/key_pool.json

ğŸš€ Adding keys to CLIProxyAPI...
ğŸ“‹ Found 0 existing keys
âœ… Added 500 keys to CLIProxyAPI
ğŸ“Š Total keys in CLIProxyAPI: 500

============================================================
âœ… All done! Keys are ready to use.
============================================================
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Key Portal

```bash
python app.py
```

è®¿é—® `http://172.16.70.100:8080`

---

## ğŸ‘¤ ç”¨æˆ·ä½¿ç”¨æµç¨‹

### 1. ç”³è¯· API Key

è®¿é—®ï¼š`http://172.16.70.100:8080/register`

å¡«å†™ä¿¡æ¯ï¼š
- **é‚®ç®±**ï¼ˆå¿…å¡«ï¼‰ï¼šç”¨äºè¯†åˆ«ç”¨æˆ·
- **å§“å**ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¾ç¤ºåç§°
- **Key æ ‡ç­¾**ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚"å·¥ä½œç”µè„‘"ã€"å®¶é‡Œç”µè„‘"

ç‚¹å‡»"ç”³è¯· API Key"ï¼Œç³»ç»Ÿè¿”å›ä¸“å± Keyï¼š
```
usr_pool_0001_a1b2c3d4e5f6
```

### 2. é…ç½® Claude Code

**æ–¹å¼ 1ï¼šç¯å¢ƒå˜é‡**
```bash
export ANTHROPIC_API_KEY="usr_pool_0001_a1b2c3d4e5f6"
export ANTHROPIC_BASE_URL="http://172.16.70.100:8317"
```

**æ–¹å¼ 2ï¼šé…ç½®æ–‡ä»¶**
```json
{
  "apiKey": "usr_pool_0001_a1b2c3d4e5f6",
  "baseUrl": "http://172.16.70.100:8317"
}
```

**æ–¹å¼ 3ï¼šå‘½ä»¤è¡Œå‚æ•°**
```bash
claude-code \
  --api-key usr_pool_0001_a1b2c3d4e5f6 \
  --base-url http://172.16.70.100:8317
```

### 3. æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡

è®¿é—®ï¼š`http://172.16.70.100:8080/my-keys`

è¾“å…¥é‚®ç®±ï¼ŒæŸ¥çœ‹ï¼š
- æ€»è¯·æ±‚æ•°ã€æ€» Token æ•°
- æ¯ä¸ª Key çš„è¯¦ç»†ä½¿ç”¨æƒ…å†µ
- å¯ä»¥æ’¤é”€ä¸å†ä½¿ç”¨çš„ Key

### 4. ç”³è¯·å¤šä¸ª Key

åŒä¸€ä¸ªé‚®ç®±å¯ä»¥å¤šæ¬¡ç”³è¯· Keyï¼Œç”¨äºï¼š
- ä¸åŒè®¾å¤‡ï¼ˆå·¥ä½œç”µè„‘ã€å®¶é‡Œç”µè„‘ï¼‰
- ä¸åŒé¡¹ç›®ï¼ˆé¡¹ç›®Aã€é¡¹ç›®Bï¼‰
- ä¾¿äºç»Ÿè®¡å’Œç®¡ç†

---

## ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜åŠŸèƒ½

### æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡

è®¿é—®ï¼š`http://172.16.70.100:8080/admin/users`

åŠŸèƒ½ï¼š
- ğŸ“Š æ€»ç”¨æˆ·æ•°ã€æ€» Keysã€æ€»è¯·æ±‚æ•°ã€æ€» Tokens
- ğŸ† ç”¨æˆ·æ’è¡Œæ¦œï¼ˆæŒ‰ Token ä½¿ç”¨é‡é™åºï¼‰
- ğŸ“ˆ æ¯ä¸ªç”¨æˆ·çš„ä½¿ç”¨å æ¯”
- ğŸ” ç‚¹å‡»ç”¨æˆ·è·³è½¬åˆ°è¯¦æƒ…é¡µ

### Key æ± ç®¡ç†

æ£€æŸ¥å‰©ä½™ Key æ•°é‡ï¼š
```bash
curl http://172.16.70.100:8080/api/key-pool-status
```

å“åº”ï¼š
```json
{
  "total": 500,
  "unused": 450,
  "assigned": 50
}
```

å¦‚æœ Key ä¸å¤Ÿï¼Œé‡æ–°ç”Ÿæˆï¼š
```bash
python generate_keys.py
```

---

## ğŸ” API æ¥å£æ–‡æ¡£

### ç”¨æˆ·æ³¨å†Œ
```http
POST /api/register-key
Content-Type: application/json

{
  "email": "user@example.com",
  "name": "å¼ ä¸‰",
  "label": "å·¥ä½œç”µè„‘"
}
```

### æŸ¥è¯¢ç”¨æˆ·çš„ Keys
```http
POST /api/my-keys
Content-Type: application/json

{
  "email": "user@example.com"
}
```

### æ’¤é”€ Key
```http
POST /api/revoke-key
Content-Type: application/json

{
  "key": "usr_pool_0001_a1b2c3d4"
}
```

### æŸ¥è¯¢ç”¨æˆ·ç»Ÿè®¡
```http
GET /api/user-stats/user@example.com
```

### æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ç»Ÿè®¡
```http
GET /api/all-users-stats
```

å“åº”ï¼š
```json
{
  "users": [
    {
      "email": "user@example.com",
      "name": "å¼ ä¸‰",
      "total_requests": 300,
      "total_tokens": 150000,
      "key_count": 2
    }
  ],
  "summary": {
    "total_users": 10,
    "total_requests": 1000,
    "total_tokens": 500000,
    "total_keys": 25
  }
}
```

---

## ğŸ“Š æ•°æ®ç»“æ„

### key_pool.json
```json
{
  "version": "1.0",
  "generated_at": "2025-01-16T00:00:00Z",
  "total": 500,
  "unused": ["usr_pool_0001_xxx", "usr_pool_0002_xxx"],
  "assigned": {
    "usr_pool_0001_xxx": "user@example.com"
  }
}
```

### user_keys.json
```json
{
  "version": "1.0",
  "users": {
    "user@example.com": {
      "email": "user@example.com",
      "name": "å¼ ä¸‰",
      "api_keys": ["usr_pool_0001_xxx", "usr_pool_0002_xxx"],
      "created_at": "2025-01-16T00:00:00Z"
    }
  },
  "keys": {
    "usr_pool_0001_xxx": {
      "email": "user@example.com",
      "label": "å·¥ä½œç”µè„‘",
      "created_at": "2025-01-16T00:00:00Z"
    }
  }
}
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. å†…å­˜ç¼“å­˜
- ç”¨æˆ· Key æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
- ç»Ÿè®¡æ•°æ®ç¼“å­˜ 5 ç§’ï¼Œå‡å°‘ API è°ƒç”¨

### 2. åŒå‘æ˜ å°„
- `users` â†’ é€šè¿‡é‚®ç®±æŸ¥æŸäººçš„æ‰€æœ‰ Key
- `keys` â†’ é€šè¿‡ Key æŸ¥å½’å±äºº

### 3. ç»Ÿè®¡èšåˆ
- è‡ªåŠ¨èšåˆä¸€ä¸ªç”¨æˆ·æ‰€æœ‰ Key çš„ä½¿ç”¨é‡
- æ”¯æŒæŒ‰å¤©ã€æŒ‰å°æ—¶ã€æŒ‰æ¨¡å‹ç»Ÿè®¡

### 4. çƒ­é‡è½½
- Key æ·»åŠ åˆ° CLIProxyAPI åç«‹å³ç”Ÿæ•ˆ
- æ— éœ€é‡å¯æœåŠ¡

---

## â“ å¸¸è§é—®é¢˜

### Q1ï¼šKey ç”¨å®Œäº†æ€ä¹ˆåŠï¼Ÿ
Aï¼šè¿è¡Œ `python generate_keys.py` ç”Ÿæˆæ›´å¤š Key

### Q2ï¼šå¦‚ä½•ç»Ÿè®¡æŸä¸ªäººçš„ç”¨é‡ï¼Ÿ
Aï¼šè®¿é—® `/my-keys` è¾“å…¥é‚®ç®±ï¼Œæˆ–è®¿é—® `/admin/users` æŸ¥çœ‹æ’è¡Œæ¦œ

### Q3ï¼šç”¨æˆ·å¯ä»¥ç”³è¯·å¤šå°‘ä¸ª Keyï¼Ÿ
Aï¼šæ²¡æœ‰é™åˆ¶ï¼Œåªè¦ Key æ± æœ‰ä½™é‡

### Q4ï¼šæ’¤é”€ Key åä¼šæ€æ ·ï¼Ÿ
Aï¼šKey è¿”å›æ± ä¸­å¯é‡æ–°åˆ†é…ï¼ŒCLIProxyAPI ä¸­ä¹Ÿä¼šåˆ é™¤

### Q5ï¼šç»Ÿè®¡æ•°æ®å¤šä¹…æ›´æ–°ï¼Ÿ
Aï¼šå®æ—¶æ›´æ–°ï¼Œ5ç§’ç¼“å­˜

### Q6ï¼šå¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ
Aï¼šå®šæœŸå¤‡ä»½ `key-portal/data/` ç›®å½•

---

## ğŸ”§ ç»´æŠ¤æ“ä½œ

### æŸ¥çœ‹æ—¥å¿—
```bash
tail -f key-portal/portal.log
```

### æ‰‹åŠ¨åŒæ­¥ç»Ÿè®¡
```bash
curl -X POST http://172.16.70.100:8080/api/sync-usage
```

### æ¸…ç©ºç¼“å­˜é‡æ–°åŠ è½½
é‡å¯ Key Portalï¼š
```bash
pkill -f "python app.py"
python app.py
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å†…å­˜ç¼“å­˜**ï¼šç”¨æˆ·æ•°æ®å’Œç»Ÿè®¡æ•°æ®éƒ½ç¼“å­˜åœ¨å†…å­˜
2. **5ç§’ TTL**ï¼šç»Ÿè®¡æ•°æ®ç¼“å­˜ 5 ç§’ï¼Œé¿å…é¢‘ç¹è°ƒç”¨ API
3. **æ‰¹é‡æ“ä½œ**ï¼šKey æ± ä¸€æ¬¡æ€§ç”Ÿæˆ 500 ä¸ªï¼Œå‡å°‘æ“ä½œæ¬¡æ•°
4. **ç´¢å¼•ä¼˜åŒ–**ï¼šåŒå‘æ˜ å°„å¿«é€ŸæŸ¥è¯¢

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„ç³»ç»Ÿæ”¯æŒï¼š
- âœ… æ¯ä¸ªç”¨æˆ·æœ‰ä¸“å± API Key
- âœ… ç²¾ç¡®ç»Ÿè®¡æ¯ä¸ªäººçš„ä½¿ç”¨é‡
- âœ… ä¸€ä¸ªé‚®ç®±å¯ç”³è¯·å¤šä¸ª Key
- âœ… å®æ—¶æ’è¡Œæ¦œå’Œè¯¦ç»†ç»Ÿè®¡

äº«å—ä½¿ç”¨å§ï¼
