<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¡çŒ® Key - CLIProxyAPI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; line-height: 1.6; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 650px; width: 100%; }
        .card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #667eea; margin-bottom: 10px; font-size: 2em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .step { background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 2px solid transparent; transition: all 0.3s; }
        .step.active { border-color: #667eea; background: #f0f4ff; }
        .step.completed { border-color: #28a745; background: #f0fff4; }
        .step-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .step-number { background: #667eea; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        .step.completed .step-number { background: #28a745; }
        .step-title { font-weight: bold; color: #333; font-size: 18px; }
        .step-content { margin-left: 51px; }
        .step-content p { margin-bottom: 15px; color: #555; }
        .btn { display: block; width: 100%; padding: 15px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }
        .btn-secondary { background: #28a745; color: white; }
        .btn-secondary:hover { background: #218838; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .input-group { margin-top: 15px; }
        textarea { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; font-family: monospace; resize: vertical; min-height: 100px; transition: border-color 0.3s; }
        textarea:focus { border-color: #667eea; outline: none; }
        textarea.error { border-color: #dc3545; }
        .paste-btn { display: inline-flex; align-items: center; gap: 8px; background: #6c757d; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; margin-bottom: 10px; }
        .paste-btn:hover { background: #5a6268; }
        .result { padding: 20px; border-radius: 12px; margin-top: 25px; display: none; }
        .result.success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #c3e6cb; }
        .result.error { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f5c6cb; }
        .nav-links { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        .nav-link { color: #667eea; text-decoration: none; font-weight: 500; }
        .nav-link:hover { text-decoration: underline; }
        .loading { display: none; text-align: center; padding: 30px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .tip { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 0 10px 10px 0; margin: 15px 0; font-size: 14px; }
        .tip strong { color: #856404; }
        .example-url { background: #e9ecef; padding: 10px 15px; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; margin-top: 10px; color: #495057; }
        .checkmark { color: #28a745; font-size: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ”‘ è´¡çŒ® Key</h1>
            <p class="subtitle">é€šè¿‡ OAuth æˆæƒè´¡çŒ®ä½ çš„ Claude è´¦å·ï¼Œè®©å›¢é˜Ÿå…±äº«ä½¿ç”¨</p>

            <div id="step1" class="step active">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">å¼€å§‹ Claude æˆæƒ</div>
                </div>
                <div class="step-content">
                    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œç³»ç»Ÿä¼šæ‰“å¼€ Claude ç™»å½•é¡µé¢ã€‚è¯·ä½¿ç”¨ä½ çš„ Claude è´¦å·ç™»å½•å¹¶å®Œæˆæˆæƒã€‚</p>
                    <button id="authBtn" class="btn btn-primary" onclick="startAuth()">ğŸš€ å¼€å§‹æˆæƒ</button>
                </div>
            </div>

            <div id="step2" class="step hidden">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">å¤åˆ¶å›è°ƒåœ°å€</div>
                </div>
                <div class="step-content">
                    <div class="tip">
                        <strong>é‡è¦æç¤ºï¼š</strong> æˆæƒå®Œæˆåï¼Œæ–°çª—å£ä¼šæ˜¾ç¤º"æ— æ³•è®¿é—®æ­¤ç½‘ç«™"æˆ–ç±»ä¼¼é”™è¯¯é¡µé¢ã€‚
                        <strong>è¿™æ˜¯æ­£å¸¸çš„ï¼</strong>è¯·å¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­çš„å®Œæ•´åœ°å€ã€‚
                    </div>

                    <p>åœ°å€æ ä¸­çš„ URL ç±»ä¼¼è¿™æ ·ï¼š</p>
                    <div class="example-url">
                        http://localhost:54545/callback?code=xxxxxx&state=yyyyyy
                    </div>

                    <div class="input-group">
                        <button class="paste-btn" onclick="pasteFromClipboard()">ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´</button>
                        <textarea id="callbackUrl" placeholder="åœ¨è¿™é‡Œç²˜è´´å®Œæ•´çš„å›è°ƒåœ°å€..."></textarea>
                    </div>

                    <button id="submitBtn" class="btn btn-secondary" onclick="submitCallback()">âœ… æäº¤å®Œæˆæˆæƒ</button>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨éªŒè¯æˆæƒä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="result" class="result"></div>

            <div class="nav-links">
                <a href="/" class="nav-link">â† è¿”å›æ•™ç¨‹</a>
                <a href="/status" class="nav-link">æŸ¥çœ‹ Key çŠ¶æ€ â†’</a>
            </div>
        </div>
    </div>

    <script>
        let authState = "";

        async function startAuth() {
            const btn = document.getElementById("authBtn");
            const step1 = document.getElementById("step1");
            btn.disabled = true;
            btn.textContent = "æ­£åœ¨è·å–æˆæƒé“¾æ¥...";

            try {
                const resp = await fetch("/api/auth-url");
                const data = await resp.json();

                if (data.error) {
                    showResult("error", "è·å–æˆæƒé“¾æ¥å¤±è´¥: " + data.error);
                    btn.disabled = false;
                    btn.textContent = "ğŸš€ å¼€å§‹æˆæƒ";
                    return;
                }

                authState = data.state;

                // Open auth page
                const authWindow = window.open(data.url, "_blank", "width=600,height=700");

                // Update UI
                step1.classList.remove("active");
                step1.classList.add("completed");
                btn.innerHTML = '<span class="checkmark">âœ“</span> å·²æ‰“å¼€æˆæƒé¡µé¢';

                // Show step 2
                const step2 = document.getElementById("step2");
                step2.classList.remove("hidden");
                step2.classList.add("active");

                // Focus on textarea
                document.getElementById("callbackUrl").focus();

            } catch (e) {
                showResult("error", "è¯·æ±‚å¤±è´¥: " + e.message);
                btn.disabled = false;
                btn.textContent = "ğŸš€ å¼€å§‹æˆæƒ";
            }
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById("callbackUrl").value = text;
                // Auto-submit if it looks valid
                if (text.includes("code=") && text.includes("state=")) {
                    submitCallback();
                }
            } catch (e) {
                // Clipboard access denied, user needs to paste manually
                document.getElementById("callbackUrl").focus();
            }
        }

        async function submitCallback() {
            const textarea = document.getElementById("callbackUrl");
            const url = textarea.value.trim();

            textarea.classList.remove("error");

            if (!url) {
                showResult("error", "è¯·ç²˜è´´å›è°ƒåœ°å€");
                textarea.classList.add("error");
                textarea.focus();
                return;
            }

            if (!url.includes("code=") || !url.includes("state=")) {
                showResult("error", "åœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿å¤åˆ¶å®Œæ•´çš„åœ°å€ï¼ˆéœ€è¦åŒ…å« code= å’Œ state= å‚æ•°ï¼‰");
                textarea.classList.add("error");
                textarea.focus();
                return;
            }

            const btn = document.getElementById("submitBtn");
            const step2 = document.getElementById("step2");
            btn.disabled = true;
            document.getElementById("loading").style.display = "block";

            try {
                const resp = await fetch("/api/submit-callback", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({callback_url: url})
                });
                const data = await resp.json();

                document.getElementById("loading").style.display = "none";

                if (data.error) {
                    showResult("error", "æˆæƒå¤±è´¥: " + data.error);
                    btn.disabled = false;
                } else {
                    step2.classList.remove("active");
                    step2.classList.add("completed");
                    step2.querySelector(".step-number").textContent = "âœ“";

                    showResult("success",
                        "ğŸ‰ <strong>æˆæƒæˆåŠŸï¼</strong><br><br>" +
                        "è´¦æˆ·: <strong>" + (data.account || "å·²æ·»åŠ ") + "</strong><br><br>" +
                        "ä½ çš„ Claude Key å·²æˆåŠŸæ³¨å†Œï¼Œç°åœ¨å¯ä»¥é€šè¿‡ API ä½¿ç”¨äº†ã€‚<br>" +
                        "Key æœ‰æ•ˆæœŸçº¦ 8 å°æ—¶ï¼Œè¿‡æœŸåè¯·é‡æ–°æˆæƒã€‚"
                    );
                }
            } catch (e) {
                document.getElementById("loading").style.display = "none";
                showResult("error", "è¯·æ±‚å¤±è´¥: " + e.message);
                btn.disabled = false;
            }
        }

        function showResult(type, message) {
            const result = document.getElementById("result");
            result.className = "result " + type;
            result.innerHTML = message;
            result.style.display = "block";
            result.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        // Auto-detect clipboard on page focus (with user permission)
        document.addEventListener("visibilitychange", function() {
            if (!document.hidden && document.getElementById("step2").classList.contains("active")) {
                // Page is visible and step 2 is active, try to read clipboard
                pasteFromClipboard();
            }
        });
    </script>
</body>
</html>
